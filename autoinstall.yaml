#cloud-config
autoinstall:
  version: 1
  locale: pt_BR.UTF-8
  keyboard:
    layout: br
  
  identity:
    hostname: BRJTNO
    username: suporte
    password: $6$v2hQvx/ec0AE3gpA$VpADlI.hi.Ban4lTTsFtqzmoC46aqplwrwW/9/6cGvrL.6G8apb/H9lX5BvzNBAHyxdzyAoStJWRH9sVDFswk0
  
  storage:
    layout:
      name: custom
    config:
      # Disco principal
      - type: disk
        id: disk-nvme
        path: /dev/nvme0n1
        ptable: gpt
        wipe: superblock-recursive
      
      # Partição EFI (1GB)
      - type: partition
        id: partition-efi
        device: disk-nvme
        number: 1
        size: 1G
        flag: boot
        grub_device: true
      
      # Partição Boot (2GB)
      - type: partition
        id: partition-boot
        device: disk-nvme
        number: 2
        size: 2G
      
      # Partição para criptografia (resto do disco)
      - type: partition
        id: partition-encrypted
        device: disk-nvme
        number: 3
        size: -1
      
      # Formatação EFI
      - type: format
        id: format-efi
        fstype: fat32
        volume: partition-efi
      
      # Formatação Boot
      - type: format
        id: format-boot
        fstype: ext4
        volume: partition-boot
      
      # Configuração de criptografia LUKS
      - type: dm_crypt
        id: dmcrypt-root
        volume: partition-encrypted
        dm_name: dm_crypt-0
        key: "mudar123"
      
      # Grupo de volume LVM
      - type: lvm_volgroup
        id: ubuntu-vg
        name: ubuntu-vg
        devices:
          - dmcrypt-root
      
      # Volume lógico LVM
      - type: lvm_partition
        id: ubuntu-lv
        name: ubuntu-lv
        volgroup: ubuntu-vg
        size: -1
      
      # Formatação do volume LVM
      - type: format
        id: format-root
        fstype: ext4
        volume: ubuntu-lv
      
      # Montagens
      - type: mount
        id: mount-efi
        device: format-efi
        path: /boot/efi
      
      - type: mount
        id: mount-boot
        device: format-boot
        path: /boot
      
      - type: mount
        id: mount-root
        device: format-root
        path: /
  
  packages:
    - ubuntu-desktop-minimal
    - cryptsetup
    - lvm2
  
  timezone: America/Sao_Paulo
  
  late-commands:
    - echo 'Instalação com EFI + Boot + LVM sobre LUKS concluída'
